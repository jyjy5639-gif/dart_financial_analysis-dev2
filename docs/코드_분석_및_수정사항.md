# DART 재무정보 분석기 - 코드 분석 및 수정사항

## 📋 분석 일자: 2026-01-24

---

## 🔴 주요 문제점

### 1. Import 경로 오류 (Critical)

#### 문제점:
프로젝트 전반에 걸쳐 **상대 경로**와 **절대 경로**가 혼재되어 있음

#### 발견된 오류:

**A. backend/main.py**
```python
# ❌ 현재 (상대 경로)
from api.routes import company, financial, briefing

# ✅ 수정 필요 (절대 경로)
from backend.api.routes import company, financial, briefing
```

**B. backend/api/routes/company.py**
```python
# ❌ 현재 (혼재)
from services.dart_service import DARTService
from api.dependencies import get_dart_service
from shared.schemas import Company, CompanySearchResponse, ErrorResponse

# ✅ 수정 필요
from backend.services.dart_service import DARTService
from backend.api.dependencies import get_dart_service
from shared.schemas import Company, CompanySearchResponse, ErrorResponse
```

**C. backend/api/routes/financial.py**
```python
# ✅ 이미 절대 경로 사용 (올바름)
from backend.services.dart_service import DARTService
from backend.services.financial_service import FinancialService
from backend.services.stock_service import StockService
from backend.api.dependencies import get_dart_service, get_financial_service, get_stock_service
```

**D. backend/api/routes/briefing.py**
```python
# ✅ 이미 절대 경로 사용 (올바름)
from backend.services.llm_service import LLMService
from backend.api.dependencies import get_llm_service
```

**E. backend/api/dependencies.py**
```python
# ❌ 현재 (상대 경로)
from services.dart_service import DARTService
from services.krx_service import KRXService
from services.stock_service import StockService
from services.llm_service import LLMService
from services.financial_service import FinancialService

# ✅ 수정 필요
from backend.services.dart_service import DARTService
from backend.services.krx_service import KRXService
from backend.services.stock_service import StockService
from backend.services.llm_service import LLMService
from backend.services.financial_service import FinancialService
```

**F. backend/services/dart_service.py**
```python
# ❌ 현재
from repositories.dart_repository import DARTRepository
from repositories.krx_repository import KRXRepository
from core.exceptions import CompanyNotFoundException

# ✅ 수정 필요
from backend.repositories.dart_repository import DARTRepository
from backend.repositories.krx_repository import KRXRepository
from backend.core.exceptions import CompanyNotFoundException
```

**G. backend/services/llm_service.py**
```python
# ❌ 현재
from core.llm import (
    BaseLLMProvider,
    GeminiProvider,
    OpenAIProvider,
    ClaudeProvider,
    UpstageProvider
)
from core.exceptions import LLMException
from core.config import settings

# ✅ 수정 필요
from backend.core.llm import (
    BaseLLMProvider,
    GeminiProvider,
    OpenAIProvider,
    ClaudeProvider,
    UpstageProvider
)
from backend.core.exceptions import LLMException
from backend.core.config import settings
```

**H. backend/services/__init__.py**
```python
# ❌ 현재
from services.dart_service import DARTService
from services.krx_service import KRXService
from services.stock_service import StockService
from services.llm_service import LLMService
from services.financial_service import FinancialService

# ✅ 수정 필요
from backend.services.dart_service import DARTService
from backend.services.krx_service import KRXService
from backend.services.stock_service import StockService
from backend.services.llm_service import LLMService
from backend.services.financial_service import FinancialService
```

---

### 2. 누락된 `__init__.py` 파일

#### 문제점:
Python 패키지로 인식되기 위해 필요한 `__init__.py` 파일이 누락됨

#### 누락된 파일:
- ❌ `backend/__init__.py` - **필수**
- ❌ `backend/models/__init__.py`
- ❌ `backend/repositories/__init__.py`
- ❌ `backend/core/__init__.py` - 이미 존재하지만 확인 필요
- ❌ `backend/utils/__init__.py`

---

### 3. 서비스 코드 로직 문제

#### A. dart_service.py의 중복 로직

**문제:**
```python
# dart_service.py에 재무 비율 계산 로직이 있음
def _calc_ratios(self, data: List[Dict]) -> Dict[str, Dict[str, float]]:
    # ...비율 계산 로직...

# 그런데 financial_service.py에도 동일한 로직이 있음
def calculate_ratios(self, data: List[dict]) -> Dict[str, Dict[str, float]]:
    # ...비율 계산 로직...
```

**해결방안:**
- `DARTService`는 데이터 조회만 담당
- `FinancialService`가 모든 재무 계산 담당
- 중복 제거 필요

#### B. dart_service.py의 잘못된 import

```python
# ❌ 현재
from ..utils.formatters import safe_float

# ✅ 수정 필요
from backend.utils.formatters import safe_float
```

이 import는 상대 경로(`..')를 사용하고 있는데, 절대 경로로 변경 필요

---

### 4. API 라우트 경로 불일치

#### 문제점:
```python
# financial.py
router = APIRouter(prefix="/api/financial", tags=["financial"])

# briefing.py
router = APIRouter(prefix="/api/briefing", tags=["briefing"])

# company.py
router = APIRouter(prefix="/companies", tags=["companies"])
```

**일관성 문제:**
- `company.py`는 `/companies`
- `financial.py`, `briefing.py`는 `/api/...`

**추천 방안:**
모두 `/api/...` 형식으로 통일하거나, prefix를 제거하고 `main.py`에서 통합 관리

---

### 5. LLM 서비스 비동기 처리 불일치

#### 문제:
```python
# briefing.py에서
async def generate_briefing(...):
    # ...
    briefing = llm_service.generate_briefing(...)  # ❌ await 없음

# llm_service.py에서
async def generate_briefing(...) -> str:  # async 함수인데...
```

**수정 필요:**
```python
# briefing.py에서
briefing = await llm_service.generate_briefing(...)  # ✅ await 추가
```

---

### 6. 환경변수 및 API 키 관리 문제

#### A. dependencies.py의 헤더 인증

```python
def get_dart_service(api_key: str = Header(..., alias="X-DART-API-Key")) -> DARTService:
```

이 방식은 Streamlit 프론트엔드에서 사용하기 번거로움

**개선 방안:**
- 환경변수에서 기본값 로드
- 프론트엔드에서 선택적으로 오버라이드 가능하도록

#### B. LLM Service 초기화 문제

```python
def _initialize_providers(self):
    if settings.gemini_api_key:
        self.providers['gemini'] = GeminiProvider(settings.gemini_api_key)
```

이 방식은 런타임에 API 키를 동적으로 추가할 수 없음

**개선 필요:**
`register_provider` 메서드 활용

---

## 🟡 경고 사항

### 1. 파일 및 디렉토리 확인 필요

다음 파일들의 존재 여부와 내용 확인 필요:
- `backend/repositories/dart_repository.py`
- `backend/repositories/krx_repository.py`
- `backend/core/llm/__init__.py` 및 각 provider 파일들
- `backend/utils/formatters.py`
- `backend/models/` 내 모델 파일들

### 2. Exception 처리

`backend/core/exceptions.py`의 커스텀 예외 클래스들이 정의되어 있는지 확인 필요:
- `CompanyNotFoundException`
- `LLMException`

---

## ✅ 수정 계획

### Phase 1: 프로젝트 구조 수정

1. **누락된 `__init__.py` 파일 생성**
2. **모든 import를 절대 경로로 통일**
3. **PYTHONPATH 설정 방법 문서화**

### Phase 2: 서비스 로직 개선

1. **중복 코드 제거** (DARTService vs FinancialService)
2. **비동기 처리 일관성 확보**
3. **API 라우트 경로 통일**

### Phase 3: 실행 스크립트 작성

1. **루트에서 실행 가능한 스크립트 작성**
   - `run_backend.py`
   - `run_frontend.py`
   - `run_all.py`

---

## 📝 다음 단계

1. 누락된 파일 확인 및 생성
2. Import 경로 일괄 수정
3. 중복 로직 제거 및 리팩토링
4. 실행 스크립트 작성
5. 테스트 수행

---

## 🎯 최종 목표

✅ 루트 디렉토리(`D:\dev\refactor_dart`)에서 다음 명령으로 실행 가능:

```bash
# 백엔드 실행
python run_backend.py

# 프론트엔드 실행
python run_frontend.py

# 전체 실행
python run_all.py
```

모든 import가 절대 경로로 통일되어 어디서든 실행 가능한 구조
